<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ContractGuard AI - Contract Intelligence Platform</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        .chat-message {
            animation: fadeIn 0.3s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .typing-indicator span {
            animation: bounce 1.4s infinite ease-in-out both;
        }
        .typing-indicator span:nth-child(1) { animation-delay: -0.32s; }
        .typing-indicator span:nth-child(2) { animation-delay: -0.16s; }
        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen" x-data="contractGuard()">
    <!-- Header -->
    <header class="bg-indigo-600 text-white shadow-lg">
        <div class="container mx-auto px-4 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <i class="fas fa-file-contract text-2xl"></i>
                    <h1 class="text-xl font-bold">ContractGuard AI</h1>
                </div>
                <div class="flex items-center space-x-4">
                    <span class="text-sm" x-text="sessionId ? 'Session: ' + sessionId.slice(0, 8) + '...' : 'No Session'"></span>
                    <button @click="createSession()" class="bg-indigo-500 hover:bg-indigo-400 px-3 py-1 rounded text-sm">
                        New Session
                    </button>
                </div>
            </div>
        </div>
    </header>

    <div class="container mx-auto px-4 py-6">
        <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
            <!-- Sidebar - Documents -->
            <div class="lg:col-span-1">
                <!-- Upload Section -->
                <div class="bg-white rounded-lg shadow p-4 mb-4">
                    <h2 class="font-semibold text-gray-800 mb-3 flex items-center">
                        <i class="fas fa-upload mr-2 text-indigo-600"></i>
                        Upload Contract
                    </h2>
                    <form @submit.prevent="uploadDocument()">
                        <div class="border-2 border-dashed border-gray-300 rounded-lg p-4 text-center hover:border-indigo-400 transition-colors"
                             @dragover.prevent="dragover = true"
                             @dragleave.prevent="dragover = false"
                             @drop.prevent="handleDrop($event)"
                             :class="{ 'border-indigo-400 bg-indigo-50': dragover }">
                            <input type="file" id="fileInput" class="hidden" accept=".pdf,.md,.txt" @change="handleFileSelect($event)">
                            <label for="fileInput" class="cursor-pointer">
                                <i class="fas fa-cloud-upload-alt text-3xl text-gray-400 mb-2"></i>
                                <p class="text-sm text-gray-600">Drop PDF here or click to upload</p>
                                <p class="text-xs text-gray-400 mt-1" x-text="selectedFile ? selectedFile.name : 'Supports: PDF, MD, TXT'"></p>
                            </label>
                        </div>
                        <button type="submit"
                                class="w-full mt-3 bg-indigo-600 text-white py-2 rounded hover:bg-indigo-700 disabled:opacity-50"
                                :disabled="!selectedFile || uploading">
                            <span x-show="!uploading">Upload</span>
                            <span x-show="uploading"><i class="fas fa-spinner fa-spin"></i> Uploading...</span>
                        </button>
                    </form>
                </div>

                <!-- Documents List -->
                <div class="bg-white rounded-lg shadow p-4">
                    <h2 class="font-semibold text-gray-800 mb-3 flex items-center">
                        <i class="fas fa-folder-open mr-2 text-indigo-600"></i>
                        Documents
                    </h2>
                    <div class="space-y-2 max-h-64 overflow-y-auto">
                        <template x-for="doc in documents" :key="doc.id">
                            <div class="flex items-center justify-between p-2 bg-gray-50 rounded hover:bg-gray-100 cursor-pointer"
                                 @click="selectDocument(doc)"
                                 :class="selectedDocId === doc.id ? 'ring-2 ring-indigo-500 bg-indigo-50' : ''">
                                <div class="flex items-center space-x-2 flex-1 min-w-0">
                                    <i class="fas fa-file-pdf text-red-500 flex-shrink-0"></i>
                                    <span class="text-sm truncate" x-text="doc.filename" :title="doc.filename"></span>
                                </div>
                                <span class="text-xs px-2 py-1 rounded flex-shrink-0 ml-2"
                                      :class="doc.status === 'COMPLETED' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'"
                                      x-text="doc.status"></span>
                            </div>
                        </template>
                        <p x-show="documents.length === 0" class="text-sm text-gray-500 text-center py-4">
                            No documents uploaded yet
                        </p>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="bg-white rounded-lg shadow p-4 mt-4">
                    <h2 class="font-semibold text-gray-800 mb-3 flex items-center">
                        <i class="fas fa-bolt mr-2 text-yellow-500"></i>
                        Quick Actions
                    </h2>
                    <div class="space-y-2">
                        <button @click="askQuestion('What are the key risks in this contract?')"
                                class="w-full text-left text-sm p-2 bg-gray-50 rounded hover:bg-indigo-50 hover:text-indigo-700">
                            <i class="fas fa-exclamation-triangle mr-2 text-yellow-500"></i>
                            Analyze Risks
                        </button>
                        <button @click="askQuestion('Generate an executive summary of this contract')"
                                class="w-full text-left text-sm p-2 bg-gray-50 rounded hover:bg-indigo-50 hover:text-indigo-700">
                            <i class="fas fa-file-alt mr-2 text-blue-500"></i>
                            Executive Summary
                        </button>
                        <button @click="askQuestion('What are the termination conditions?')"
                                class="w-full text-left text-sm p-2 bg-gray-50 rounded hover:bg-indigo-50 hover:text-indigo-700">
                            <i class="fas fa-door-open mr-2 text-red-500"></i>
                            Termination Terms
                        </button>
                        <button @click="askQuestion('List all obligations for each party')"
                                class="w-full text-left text-sm p-2 bg-gray-50 rounded hover:bg-indigo-50 hover:text-indigo-700">
                            <i class="fas fa-tasks mr-2 text-green-500"></i>
                            List Obligations
                        </button>
                    </div>
                </div>
            </div>

            <!-- Main Chat Area -->
            <div class="lg:col-span-3">
                <div class="bg-white rounded-lg shadow h-[calc(100vh-200px)] flex flex-col">
                    <!-- Chat Header -->
                    <div class="border-b p-4 flex items-center justify-between">
                        <div class="flex items-center space-x-3">
                            <div class="w-10 h-10 bg-indigo-100 rounded-full flex items-center justify-center">
                                <i class="fas fa-robot text-indigo-600"></i>
                            </div>
                            <div>
                                <h2 class="font-semibold text-gray-800">ContractGuard Assistant</h2>
                                <p class="text-xs text-gray-500">Powered by Gemini 2.0 & Google ADK</p>
                            </div>
                        </div>
                        <div class="flex items-center space-x-2">
                            <span class="flex items-center text-xs" :class="connected ? 'text-green-600' : 'text-red-600'">
                                <i class="fas fa-circle text-xs mr-1"></i>
                                <span x-text="connected ? 'Connected' : 'Disconnected'"></span>
                            </span>
                        </div>
                    </div>

                    <!-- Messages -->
                    <div class="flex-1 overflow-y-auto p-4 space-y-4" id="chatMessages">
                        <template x-for="(msg, index) in messages" :key="index">
                            <div class="chat-message" :class="msg.role === 'user' ? 'flex justify-end' : 'flex justify-start'">
                                <div :class="msg.role === 'user' ? 'bg-indigo-600 text-white' : 'bg-gray-100 text-gray-800'"
                                     class="max-w-3xl rounded-lg p-4 shadow-sm">
                                    <div class="flex items-start space-x-2">
                                        <i :class="msg.role === 'user' ? 'fas fa-user' : 'fas fa-robot'"
                                           class="mt-1 text-sm"></i>
                                        <div class="flex-1">
                                            <div class="prose prose-sm" x-html="formatMessage(msg.content)"></div>
                                            <template x-if="msg.sources && msg.sources.length > 0">
                                                <div class="mt-2 pt-2 border-t border-gray-200">
                                                    <p class="text-xs font-semibold mb-1">Sources:</p>
                                                    <template x-for="source in msg.sources" :key="source">
                                                        <span class="inline-block text-xs bg-gray-200 rounded px-2 py-1 mr-1 mb-1"
                                                              x-text="source"></span>
                                                    </template>
                                                </div>
                                            </template>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </template>

                        <!-- Typing Indicator -->
                        <div x-show="isTyping" class="flex justify-start">
                            <div class="bg-gray-100 rounded-lg p-4">
                                <div class="typing-indicator flex space-x-1">
                                    <span class="w-2 h-2 bg-gray-400 rounded-full"></span>
                                    <span class="w-2 h-2 bg-gray-400 rounded-full"></span>
                                    <span class="w-2 h-2 bg-gray-400 rounded-full"></span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Input Area -->
                    <div class="border-t p-4">
                        <form @submit.prevent="sendMessage()" class="flex space-x-2">
                            <input type="text"
                                   x-model="userInput"
                                   placeholder="Ask about your contracts..."
                                   class="flex-1 border rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500"
                                   :disabled="isTyping">
                            <button type="submit"
                                    class="bg-indigo-600 text-white px-6 py-2 rounded-lg hover:bg-indigo-700 disabled:opacity-50"
                                    :disabled="!userInput.trim() || isTyping">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </form>
                        <div class="mt-2 flex flex-wrap gap-2">
                            <button @click="askQuestion('What is the confidentiality period?')"
                                    class="text-xs bg-gray-100 hover:bg-gray-200 rounded-full px-3 py-1">
                                Confidentiality period?
                            </button>
                            <button @click="askQuestion('What is the liability cap?')"
                                    class="text-xs bg-gray-100 hover:bg-gray-200 rounded-full px-3 py-1">
                                Liability cap?
                            </button>
                            <button @click="askQuestion('Who are the parties involved?')"
                                    class="text-xs bg-gray-100 hover:bg-gray-200 rounded-full px-3 py-1">
                                Parties involved?
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Status Bar -->
    <footer class="fixed bottom-0 left-0 right-0 bg-gray-800 text-white text-xs py-2 px-4">
        <div class="container mx-auto flex justify-between items-center">
            <span>ContractGuard AI v1.0 | Kaggle Agents Intensive Capstone</span>
            <div class="flex items-center space-x-4">
                <a href="/docs" target="_blank" class="hover:text-indigo-400">
                    <i class="fas fa-book mr-1"></i> API Docs
                </a>
                <a href="/health" target="_blank" class="hover:text-indigo-400">
                    <i class="fas fa-heartbeat mr-1"></i> Health
                </a>
            </div>
        </div>
    </footer>

    <script>
        const API_BASE = '';  // Same origin

        function contractGuard() {
            return {
                // State
                sessionId: null,
                messages: [],
                documents: [],
                userInput: '',
                selectedFile: null,
                selectedDocId: null,
                uploading: false,
                isTyping: false,
                connected: false,
                dragover: false,
                ws: null,

                // Initialize
                async init() {
                    await this.checkHealth();
                    await this.createSession();
                    await this.loadDocuments();
                    this.addWelcomeMessage();
                },

                // Health check
                async checkHealth() {
                    try {
                        const res = await fetch(`${API_BASE}/health`);
                        this.connected = res.ok;
                    } catch (e) {
                        this.connected = false;
                    }
                },

                // Session management
                async createSession() {
                    try {
                        const res = await fetch(`${API_BASE}/api/v1/sessions`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ user_id: 'web-user-' + Date.now() })
                        });
                        if (res.ok) {
                            const data = await res.json();
                            this.sessionId = data.session_id;
                        }
                    } catch (e) {
                        console.error('Failed to create session:', e);
                    }
                },

                // Welcome message
                addWelcomeMessage() {
                    this.messages.push({
                        role: 'assistant',
                        content: `üëã Welcome to **ContractGuard AI**!

I'm your intelligent contract analysis assistant. I can help you:

- üîç **Search** for specific clauses and terms
- ‚ö†Ô∏è **Identify risks** in your contracts
- üìä **Compare** multiple contracts
- üìù **Generate reports** and summaries

**Get started by uploading a contract** on the left, then ask me anything about it!

Try asking: "What are the termination conditions?" or "Analyze the risks in this contract."`
                    });
                },

                // Load documents
                async loadDocuments() {
                    try {
                        const res = await fetch(`${API_BASE}/api/v1/documents`);
                        if (res.ok) {
                            const data = await res.json();
                            // Map API response to frontend format
                            this.documents = (data.documents || []).map(doc => ({
                                id: doc.document_id,
                                filename: doc.filename,
                                status: 'COMPLETED',
                                size: doc.size_bytes
                            }));
                        }
                    } catch (e) {
                        console.error('Failed to load documents:', e);
                    }
                },

                // File handling
                handleFileSelect(event) {
                    this.selectedFile = event.target.files[0];
                },

                handleDrop(event) {
                    this.dragover = false;
                    const files = event.dataTransfer.files;
                    if (files.length > 0) {
                        this.selectedFile = files[0];
                    }
                },

                // Upload document
                async uploadDocument() {
                    if (!this.selectedFile) return;

                    this.uploading = true;
                    const formData = new FormData();
                    formData.append('file', this.selectedFile);
                    formData.append('collection_name', 'contracts');

                    try {
                        const res = await fetch(`${API_BASE}/api/v1/documents/upload`, {
                            method: 'POST',
                            body: formData
                        });

                        if (res.ok) {
                            const data = await res.json();
                            this.messages.push({
                                role: 'assistant',
                                content: `‚úÖ Document **${this.selectedFile.name}** uploaded successfully!\n\nDocument ID: \`${data.document_id}\`\nChunks created: ${data.chunks || 'Processing...'}\n\nYou can now ask questions about this document.`
                            });
                            await this.loadDocuments();
                        } else {
                            const error = await res.json();
                            this.messages.push({
                                role: 'assistant',
                                content: `‚ùå Failed to upload document: ${error.detail || 'Unknown error'}`
                            });
                        }
                    } catch (e) {
                        this.messages.push({
                            role: 'assistant',
                            content: `‚ùå Upload error: ${e.message}`
                        });
                    } finally {
                        this.uploading = false;
                        this.selectedFile = null;
                        document.getElementById('fileInput').value = '';
                    }
                },

                // Select document
                selectDocument(doc) {
                    this.selectedDocId = doc.id;
                    const sizeKB = doc.size ? Math.round(doc.size / 1024) : 'N/A';
                    this.messages.push({
                        role: 'assistant',
                        content: `üìÑ Selected document: **${doc.filename}**\n\nDocument ID: \`${doc.id}\`\nStatus: ${doc.status}\nSize: ${sizeKB} KB\n\nYou can now ask questions about this document. Try:\n- "What are the key risks?"\n- "Summarize the main obligations"\n- "What is the termination clause?"`
                    });
                    this.scrollToBottom();
                },

                // Ask question
                askQuestion(question) {
                    this.userInput = question;
                    this.sendMessage();
                },

                // Send message
                async sendMessage() {
                    const question = this.userInput.trim();
                    if (!question) return;

                    // Add user message
                    this.messages.push({ role: 'user', content: question });
                    this.userInput = '';
                    this.isTyping = true;
                    this.scrollToBottom();

                    try {
                        const res = await fetch(`${API_BASE}/api/v1/query`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                question: question,
                                session_id: this.sessionId
                            })
                        });

                        if (res.ok) {
                            const data = await res.json();
                            this.messages.push({
                                role: 'assistant',
                                content: data.answer || data.response || 'No response received.',
                                sources: data.sources || []
                            });
                        } else {
                            const error = await res.json();
                            this.messages.push({
                                role: 'assistant',
                                content: `‚ùå Error: ${error.detail || 'Failed to get response'}`
                            });
                        }
                    } catch (e) {
                        this.messages.push({
                            role: 'assistant',
                            content: `‚ùå Connection error: ${e.message}. Please check if the server is running.`
                        });
                    } finally {
                        this.isTyping = false;
                        this.scrollToBottom();
                    }
                },

                // Format message with markdown
                formatMessage(content) {
                    if (!content) return '';
                    // Basic markdown formatting
                    return content
                        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                        .replace(/\*(.*?)\*/g, '<em>$1</em>')
                        .replace(/`(.*?)`/g, '<code class="bg-gray-200 px-1 rounded">$1</code>')
                        .replace(/\n/g, '<br>')
                        .replace(/- (.*?)(<br>|$)/g, '‚Ä¢ $1$2');
                },

                // Scroll to bottom
                scrollToBottom() {
                    this.$nextTick(() => {
                        const container = document.getElementById('chatMessages');
                        container.scrollTop = container.scrollHeight;
                    });
                }
            };
        }
    </script>
</body>
</html>
